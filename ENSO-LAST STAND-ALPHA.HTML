<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Adventure</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a retro terminal look */
        body {
            font-family: 'Inter', monospace; /* Using Inter, fallback to monospace */
            background-color: #1a202c; /* Dark background */
            color: #48bb78; /* Green text for terminal feel */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .game-container {
            width: 90%; /* Responsive width */
            max-width: 800px; /* Max width for larger screens */
            height: 90vh; /* Responsive height */
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border: 2px solid #48bb78; /* Green border */
            border-radius: 0.75rem; /* Rounded corners */
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            box-shadow: 0 0 20px rgba(72, 187, 120, 0.5); /* Green glow effect */
            overflow: hidden; /* Ensure content within stays */
        }
        .game-output {
            flex-grow: 1; /* Allows output area to take available space */
            background-color: #1a202c; /* Inner dark background */
            border: 1px solid #48bb78; /* Inner green border */
            border-radius: 0.5rem; /* Rounded corners for output */
            padding: 1rem;
            overflow-y: auto; /* Scroll for long text */
            margin-bottom: 1rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
        }
        .game-input-area {
            display: flex;
            gap: 0.5rem;
        }
        .game-input {
            flex-grow: 1; /* Input takes most space */
            background-color: #1a202c;
            border: 1px solid #48bb78;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: #48bb78;
            outline: none; /* Remove default focus outline */
            caret-color: #48bb78; /* Green cursor */
            font-family: 'Inter', monospace;
        }
        .game-input::placeholder {
            color: #a0aec0; /* Lighter grey for placeholder */
        }
        .game-submit-btn {
            background-color: #48bb78; /* Green button */
            color: #1a202c; /* Dark text for button */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none; /* Remove default button border */
        }
        .game-submit-btn:hover {
            background-color: #38a169; /* Darker green on hover */
        }
        /* Style for displaying bold messages */
        .game-output strong {
            color: #f6ad55; /* Orange for emphasis */
        }
    </style>
</head>
<body class="antialiased">
    <div class="game-container">
        <div id="game-output" class="game-output">
            <!-- Game messages will appear here -->
        </div>
        <div class="game-input-area">
            <input type="text" id="game-input" class="game-input" placeholder="Type your command...">
            <button id="submit-command" class="game-submit-btn">Go</button>
        </div>
    </div>

    <script>
        // --- Game Elements ---
        const gameOutput = document.getElementById('game-output');
        const gameInput = document.getElementById('game-input');
        const submitButton = document.getElementById('submit-command');

        // --- Game World Data ---
        const rooms = {
            'starting_room': {
                description: "You awaken in a damp, musty cellar. A faint light filters through a crack in the ceiling. Crows circle above the broken ceiling. You donâ€™t remember how you got hereâ€¦ but your hands glow faintly with forbidden power.",
                exits: {
                    'north': 'wooden_door_room',
                    'east': 'dark_passage'
                },
                items: []
            },
            'wooden_door_room': {
                description: "You stand before a massive, reinforced wooden door. It looks incredibly sturdy. There's nothing else here. You can go back south.",
                exits: {
                    'south': 'starting_room'
                },
                items: []
            },
            'dark_passage': {
                description: "The passage is cold and smells of stale air. You hear dripping water somewhere ahead. You can go west to return to the cellar, or continue deeper east.",
                exits: {
                    'west': 'starting_room',
                    'east': 'cavern_entrance'
                },
                items: []
            },
            'cavern_entrance': {
                description: "The dark passage opens into a small, echoing cavern. A faint, glowing mushroom illuminates the damp walls. There's a shimmering pool of water in the center. You can go west to the dark passage.",
                exits: {
                    'west': 'dark_passage'
                },
                items: ['glowing mushroom']
            }
        };

        // --- Skill Definitions ---
        // Centralized definitions for all skills, including descriptions, costs, etc.
        const skillDefinitions = {
            // Base Warrior Skills
            'Slash': { description: 'Deal 8â€“12 damage to a single enemy.', cost: 0, resource: 'Momentum' },
            'Guard': { description: 'Reduce incoming damage by 25% next turn.', cost: 0, resource: 'Momentum' },
            'Power Strike': { description: 'Spend 2 Momentum to deal 14â€“20 damage.', cost: 2, resource: 'Momentum' },

            // Vanguard Branch Skills
            'Shield Bash': { description: 'Deal 10â€“14 damage, stun 1 turn if Momentum â‰¥ 3.', cost: 0, resource: 'Momentum', combatFlavor: "Your shield rings out like a drum, shaking the foeâ€™s footing." },
            'Mounted Charge': { description: 'Charge a target, dealing damage and gaining momentum. Gained via Tourney of Crowns prestige quest.', cost: 1, resource: 'Momentum' }, // Prestige Skill
            'Shield Charge': { description: 'Rush an ally, taunt enemies around them. Deals 8â€“12 dmg.', cost: 1, resource: 'Oath Points' },
            'Holy Smite': { description: 'Spend all Oath Points to deal 15â€“25 radiant dmg (+5 vs Undead/Void).', cost: 'all', resource: 'Oath Points' },
            'Soul Rend': { description: 'Consume all Sin Marks to deal 25â€“35 AOE dmg (ignores armor).', cost: 'all', resource: 'Sin Marks', combatFlavor: "Your blade drinks deep, shadows screaming with each cut." },

            // Berserker Branch Skills
            'Hemorrhage': { description: 'Deal 10â€“16 damage + bleed (3 dmg/turn for 3 turns).', cost: 1, resource: 'Fury Gauge', combatFlavor: "Pain sharpens your grin as the blood runs hotter." },
            'Whirlwind': { description: 'Deal 8â€“12 AOE damage to all enemies.', cost: 2, resource: 'Fury Gauge' },
            'Lunge': { description: 'Leap to target, deal 15â€“22 damage, gain 2 Fury.', cost: 1, resource: 'Fury Gauge' },
            'Sever Spine': { description: 'Once per boss fight, deal 30â€“40 true damage.', cost: 0, resource: 'Fury Gauge', combatFlavor: "The great beast falls silent, its last breath stolen by your strike." },

            // Warden Branch Skills
            'Pincushion': { description: 'Apply [Pin] Mark, reducing target speed by 50%.', cost: 0, resource: 'Marks', combatFlavor: "The enemyâ€™s advance falters as your spear finds its mark." },
            'Lockstep': { description: 'Taunt enemies in your zone for 1 turn.', cost: 1, resource: 'Marks' },
            'Expose Weakness': { description: 'Apply [Expose] Mark, increasing dmg taken by 20% for 2 turns.', cost: 1, resource: 'Marks' },
            'Fortress': { description: 'Create a zone lasting 3 turns, allies take -20% dmg inside.', cost: 2, resource: 'Marks' },

            // Necromancer Base Skills
            'Grave Bolt': { description: '10â€“14 dmg, +2 dmg per corpse on the battlefield.', cost: 1, resource: 'Soul Energy' },
            'Raise Skeleton': { description: 'Summon skeleton (5â€“7 dmg per turn).', cost: 2, resource: 'Soul Energy' },
            'Soul Leech': { description: 'Deal 8 dmg, heal for half dmg dealt.', cost: 1, resource: 'Soul Energy' },

            // Bone Warden Branch Skills
            'Bone Wall': { description: 'Absorb next hit completely.', cost: 0, resource: 'Soul Energy' }, // Placeholder for resource cost after resource evolution
            'Shield of the Dead': { description: 'Minions taunt enemies for 1 turn.', cost: 1, resource: 'Soul Energy' },
            'Reaperâ€™s Charge': { description: '20â€“28 dmg + stun.', cost: 2, resource: 'Soul Energy' },

            // Plaguecaller Branch Skills
            'Contagion': { description: 'Infect target; spreads if they die.', cost: 1, resource: 'Soul Energy' },
            'Black Spit': { description: 'Apply [Weaken] + 5 dmg/turn.', cost: 1, resource: 'Soul Energy' },
            'Corpse Bloom': { description: 'Explode corpse, 15 dmg AOE + infection.', cost: 2, resource: 'Soul Energy' },
            'Plague Wind': { description: 'Spread all infections instantly to all enemies.', cost: 'all', resource: 'Soul Energy' },

            // Soulbinder Branch Skills
            'Soul Chain': { description: 'Link 2 targets; dmg to one hits both.', cost: 1, resource: 'Soul Energy' },
            'Possession': { description: 'Control an enemy for 1 turn.', cost: 3, resource: 'Soul Energy' },

            // Ascended Overdrives (Special Skills at max evolution)
            'Oblivion Reign': { description: 'Next 3 turns, all attacks are true dmg & heal you.', cost: 'all', resource: 'Sin Marks', oncePerFight: true },
            'Dragonâ€™s Dominion': { description: 'Triple dmg vs bosses for 1 turn.', cost: 'all', resource: 'Fury Gauge', oncePerFight: true },
            'Total Lockdown': { description: 'Enemies canâ€™t move or leave zones for 2 turns.', cost: 'all', resource: 'Marks', oncePerFight: true },
            'Legion of the Dead': { description: 'Unlimited minion cap for 5 turns.', cost: 'all', resource: 'Soul Energy', oncePerFight: true }, // Black Pharaoh Ascended
            'Deathâ€™s Dominion': { description: 'All enemies instantly become undead under your control for 1 turn.', cost: 'all', resource: 'Soul Energy', oncePerFight: true }, // Deathlord Eternal Legendary
            'Unmake': { description: 'Permanently remove target from encounter.', cost: 5, resource: 'Hollow Will' }, // Hollow King
            'Echo of Nothing': { description: 'Skip the enemyâ€™s next 2 turns.', cost: 3, resource: 'Hollow Will' }, // Hollow King
            'Oblivionâ€™s Call': { description: 'Entire enemy side erased for 1 turn; they cannot act or be targeted.', cost: 'all', resource: 'Hollow Will', oncePerFight: true } // Hollow King Overdrive
        };


        // --- Player Base Classes Definition ---
        const basePlayerClasses = {
            'warrior': {
                description: "A strong and resilient fighter, adept with weapons. Can evolve into Vanguard, Berserker, or Warden.",
                lore: {
                    base: "Steel in your hands, resolve in your heart. You fight because you must â€” and because no one else will.",
                    role: "Starter melee, jack of all trades.",
                    identity: "Grit, survival, and the will to push forward."
                },
                startingItems: ['rusty sword', 'wooden shield', 'old key'],
                startingResource: { type: 'Momentum', initial: 1, max: 10 }, // Starts with 1 Momentum due to Battle-Ready
                baseStats: { hp: 120, strength: 10, intelligence: 5, agility: 7, baseDamageMin: 8, baseDamageMax: 12 },
                startingSkills: ['Slash', 'Guard', 'Power Strike'],
                startingTraits: [{ name: 'Battle-Ready', effect: 'Start each fight with 1 Momentum.' }]
            },
            'mage': {
                description: "A wise magic-user, skilled in arcane arts. (WIP)",
                lore: {
                    base: "You walk the path of forgotten knowledge, wielding the raw forces of creation. The arcane whispers to you, promising power beyond mortal comprehension.",
                    role: "Ranged spellcaster, burst damage, crowd control.",
                    identity: "Knowledge, control, raw magical power."
                },
                startingItems: ['wooden staff', 'spellbook', 'old key'],
                startingResource: { type: 'Mana', initial: 10, max: 20 },
                baseStats: { hp: 80, strength: 5, intelligence: 10, agility: 6, baseDamageMin: 6, baseDamageMax: 10 },
                startingSkills: ['Arcane Missile', 'Mana Shield'],
                startingTraits: []
            },
            'rogue': {
                description: "A nimble and cunning operative, good at stealth and traps. (WIP)",
                lore: {
                    base: "The shadows are your allies, silence your deadliest weapon. You move unseen, strike with precision, and vanish before a soul knows you were there.",
                    role: "High burst damage, stealth, utility.",
                    identity: "Cunning, speed, precise execution."
                },
                startingItems: ['short sword', 'lockpicks', 'old key'],
                startingResource: { type: 'Energy', initial: 5, max: 15 },
                baseStats: { hp: 90, strength: 7, intelligence: 6, agility: 10, baseDamageMin: 7, baseDamageMax: 11 },
                startingSkills: ['Stab', 'Dodge'],
                startingTraits: []
            },
            'necromancer': {
                description: "Master of death magic, summoning, and decay.",
                lore: {
                    base: "The grave is not the end â€” it is the beginning. And you? You are the one who decides what rises from it.",
                    role: "Master of death magic, summoning, and decay.",
                    identity: "Undeath, control, morbid power."
                },
                startingItems: ['cracked bone staff', 'small black journal'], // Whispering skull implied narrative item
                startingResource: { type: 'Soul Energy', initial: 0, max: 10 },
                baseStats: { hp: 80, strength: 6, intelligence: 9, agility: 6, baseDamageMin: 6, baseDamageMax: 10 },
                startingSkills: ['Grave Bolt', 'Raise Skeleton', 'Soul Leech'],
                startingTraits: []
            }
        };

        // --- Evolution Path Data ---
        const evolutionPaths = {
            'warrior': {
                base: { name: 'Warrior', description: 'Frontline melee, starter class.' },
                branches: {
                    'vanguard': {
                        name: 'Vanguard',
                        theme: 'Duty-bound defender who can turn into a corrupted anti-paladin.',
                        resourceEvolution: [
                            { level: 3, stage: 'Vanguard', type: 'Oath Points' },
                            { level: 11, stage: 'Dark Knight', type: 'Sin Marks' }
                        ],
                        stages: [
                            { level: 3, name: 'Vanguard', trait: 'Shield Discipline', traitEffect: 'Guard reduces 35% dmg instead of 25%.', skill: 'Shield Bash', lore: "Shields up, eyes forward. A Vanguard does not falter â€” they are the wall upon which the enemy breaks.", loreStance: "Protector first, fighter second.", loreEffect: "Your presence slows the battle to your pace." },
                            { level: 5, name: 'Knight', trait: 'Oathbound', traitEffect: '+1 Oath Point when blocking for an ally.', skill: 'Shield Charge', lore: "Oaths sworn in light and blood bind you to your cause. You bear the weight of those who cannot defend themselves.", loreEffect: "Respected across kingdoms for honor and discipline. Every step echoes with the weight of your duty.", prestigeQuest: "Tourney of Crowns" },
                            { level: 8, name: 'Paladin', trait: 'Divine Ward', traitEffect: 'First ally death per fight is prevented (restore 20 HP).', skill: 'Holy Smite', lore: "Your shield is not merely steel; it is the will of the heavens. Your strikes burn with justice, your presence inspires the weary.", loreEffect: "Wields holy power against darkness. The common folk speak your name in prayers." },
                            { level: 11, name: 'Dark Knight', trait: 'Sin-Eater', traitEffect: 'Oath Points become Sin Marks, double dmg but take 5% max HP true dmg per hit.', skill: 'Soul Rend', unlockTrigger: 'betrayal event', lore: "The light you swore to serve has turned its back on youâ€¦ or perhaps you on it. Oaths rot, faith crumles, and in the ashes, you find a darker strength.", loreEffect: "Armor black as midnight, blade thirsting for retribution. Powers drawn from Sin Marks that eat away at the soul." },
                            { level: 14, name: 'Abyssal King', trait: 'Sin Marks heal you instead of harming you; all attacks inflict [Silence Debt] â€” needed for Nullblade.', traitEffect: 'Sin Marks heal you instead of harming you; all attacks inflict [Silence Debt] for Legendary unlock.', skill: 'Oblivion Reign', ascended: true, lore: "The abyss answers to you. Sin no longer burns your flesh â€” it feeds you. All who speak find their words stolen, all who fight find their will broken.", loreEffect: "Walking apocalypse; silence spreads in your wake. Necessary for unlocking the Legendary Nullblade." }
                        ]
                    },
                    'berserker': {
                        name: 'Berserker',
                        theme: 'Frenzied damage dealer evolving into a mythic beast hunter.',
                        resourceEvolution: [
                            { level: 3, stage: 'Berserker', type: 'Fury Gauge' }
                        ],
                        stages: [
                            { level: 3, name: 'Berserker', trait: 'Blood Frenzy', traitEffect: '+10% dmg while below 50% HP.', skill: 'Hemorrhage', lore: "You welcome pain as a friend, for each wound only sharpens your rage. Blood is your banner.", loreEffect: "Battles are a blur of motion and screams. Fury grows with every heartbeat." },
                            { level: 5, name: 'Ravager', trait: 'Cleave Expert', traitEffect: 'Hitting 2+ enemies refunds 1 Fury.', skill: 'Whirlwind', lore: "Entire warbands fall to your relentless charge. Walls mean nothing â€” you are the storm that breaks them.", loreEffect: "Specializes in carving through multiple foes. Brutal, efficient, merciless." },
                            { level: 8, name: 'Bloodrunner', trait: 'Kill Rush', traitEffect: 'Killing an enemy grants +2 Fury & an extra turn (once/turn).', skill: 'Lunge', lore: "You are a predator in the chaos of war, darting from kill to kill with uncanny speed.", loreEffect: "Thrives on momentum and relentless pursuit. A killing blow only fuels the next." },
                            { level: 11, name: 'Dragon Slayer', trait: 'Scale Breaker', traitEffect: '+50% crit dmg vs Large enemies; immune to fear.', skill: 'Sever Spine', unlockTrigger: 'slaying a named dragon boss', lore: "The world whispers your name with awe and fear â€” you have slain what should not be slain.", loreEffect: "Dragons are your prey now. Scales, fire, and legends fall before you." },
                            { level: 14, name: 'Wyrmâ€™s End', trait: 'Boss kills grant permanent +1% all stats.', traitEffect: 'Boss kills grant permanent +1% all stats.', skill: 'Dragonâ€™s Dominion', ascended: true, lore: "No beast can stand before you. Every victory adds to your legend â€” and to your strength.", loreEffect: "Every boss slain empowers you permanently. Hunters become myths; myths become eternal." }
                        ]
                    },
                    'warden': {
                        name: 'Warden',
                        theme: 'Battlefield control, marking enemies, terrain effects.',
                        resourceEvolution: [
                            { level: 3, stage: 'Warden', type: 'Mark Tokens' }
                        ],
                        stages: [
                            { level: 3, name: 'Warden', trait: 'Hunterâ€™s Instinct', traitEffect: 'First Mark each turn is free.', skill: 'Pincushion', lore: "You see the flow of battle not in blows, but in movement. Every step an enemy takes is a step you predicted.", loreEffect: "Master of marks and battlefield control. Strikes with precision to disable and corner foes." },
                            { level: 5, name: 'Sentinel', trait: 'Zone Control', traitEffect: 'Enemies entering your zone take 5â€“8 dmg.', skill: 'Lockstep', lore: "You do not merely guard â€” you define the ground on which battles are fought.", loreEffect: "Creates danger zones enemies fear to enter. Patience turns defense into opportunity." },
                            { level: 8, name: 'Wardcaller', trait: 'Synergy Marks', traitEffect: 'Marks increase ally dmg by 10%.', skill: 'Expose Weakness', lore: "Every mark you place calls allies to action. Your enemies are no longer fighting one warrior, but an army moving as one.", loreEffect: "Turns ally attacks into devastating follow-ups. The battlefield hums with your commands." },
                            { level: 11, name: 'Bastion', trait: 'Fortified Presence', traitEffect: 'Allies in zone gain +5 armor.', skill: 'Fortress', lore: "You are the center of an unbreakable fortress. Allies thrive in your presence; enemies wither under your gaze.", loreEffect: "Creates safe havens amid chaos. Defense is your weapon." },
                            { level: 14, name: 'Iron Dominion', trait: 'Zones persist between rooms, start stacked by +1.', traitEffect: 'Zones persist between rooms and start stacked by 1.', skill: 'Total Lockdown', ascended: true, lore: "Your control extends beyond the battlefield â€” the land itself obeys. The war does not reset between battles, for the war is yours now.", loreEffect: "Zones persist, carrying your influence across the campaign. A living wall, impossible to breach." }
                        ]
                    }
                }
            },
            'necromancer': {
                base: { name: 'Necromancer', description: 'Master of death magic, summoning, and decay.' },
                branches: {
                    'bone_warden': {
                        name: 'Bone Warden',
                        theme: 'Tanky undead armies & physical defense.',
                        resourceEvolution: [], // Soul Energy does not evolve in type for this branch
                        stages: [
                            { level: 3, name: 'Bone Warden', trait: '+1 max skeleton', traitEffect: '+1 max skeleton summoned.', skill: 'Bone Wall', lore: "Your will intertwines with the bones of the earth, raising bulwarks against your foes. Every minion is a piece of your hardened resolve.", loreEffect: "You can field more skeletal allies, and raise temporary bone shields." },
                            { level: 5, name: 'Ossified Champion', trait: 'Minions gain +20% HP', traitEffect: 'Your summoned minions are tougher, granting them increased durability.', skill: 'Shield of the Dead', lore: "The very essence of undeath solidifies around your loyal legion. They become a living, unyielding wall.", loreEffect: "Your minions gain increased health, and can draw enemy aggression." },
                            { level: 8, name: 'Gravekeeper', trait: 'Can raise Ghouls', traitEffect: 'Unlock the ability to raise stronger, more aggressive Ghouls.', skill: 'Raise Ghoul', lore: "You delve deeper into the morbid arts, awakening faster, hungrier servitors from the shallow graves.", loreEffect: "You can now summon ravenous Ghouls to bolster your forces." },
                            { level: 11, name: 'Death Knight', trait: 'Summons deal +25% dmg', traitEffect: 'Your summoned creatures strike with terrifying force.', skill: 'Reaperâ€™s Charge', lore: "Clad in dread armor, your command over the dead becomes absolute. You charge into battle, a grim reaver leading your unholy host.", loreEffect: "Your summons deal significantly more damage, and you gain a powerful charging attack." },
                            { level: 14, name: 'Black Pharaoh', trait: '+3 max minions; all summons gain AOE attacks', traitEffect: 'Your legion grows vast, each servant capable of sweeping strikes.', skill: 'Legion of the Dead', ascended: true, lore: "A crown of bone, a throne of shadows. You are the architect of the endless horde, ruling over the perished with an iron will.", loreEffect: "Your maximum minion count increases dramatically, and all your summons gain area-of-effect attacks." }
                        ]
                    },
                    'plaguecaller': {
                        name: 'Plaguecaller',
                        theme: 'Disease, rot, and battlefield-wide decay.',
                        resourceEvolution: [], // Soul Energy does not evolve in type for this branch
                        stages: [
                            { level: 3, name: 'Plaguecaller', trait: 'Infection Stacks', traitEffect: 'DoTs can stack up to 3x on same enemy.', skill: 'Contagion', lore: "The air itself sickens at your touch, and your foes find their vitality draining away. Decay is your language.", loreEffect: "Your damage-over-time effects can now stack, making them deadlier." },
                            { level: 5, name: 'Pestilent Sage', trait: 'DoTs last +1 turn', traitEffect: 'Your applied blights linger longer, ensuring a slow, agonizing demise.', skill: 'Black Spit', lore: "Your mastery over miasma deepens, and your poisons become more insidious, clinging to life itself.", loreEffect: "Your damage-over-time effects persist for an additional turn, and you can apply debilitating weaknesses." },
                            { level: 8, name: 'Rotbringer', trait: 'Corpse Bloom', traitEffect: 'Corpses can explode into a burst of necrotic energy and infection.', skill: 'Corpse Bloom', lore: "The cycle of rot accelerates under your command. Every fallen foe becomes a new source of virulent blight.", loreEffect: "You can cause corpses to erupt, damaging and infecting nearby enemies." },
                            { level: 11, name: 'Harbinger of Decay', trait: 'Plague Wind', traitEffect: 'Instantly spread all infections from one enemy to all others.', skill: 'Plague Wind', lore: "A walking pestilence, you are the very embodiment of blight. What one suffers, all shall endure.", loreEffect: "You gain the power to instantly spread existing infections to all enemies on the battlefield." },
                            { level: 14, name: 'Plague Sovereign', trait: 'All DoTs become true dmg, ignore resistances.', traitEffect: 'Your diseases cut through any defense, rendering enemies utterly vulnerable.', skill: 'Plague Wind', ascended: true, lore: "The world becomes your charnel house, and life itself recoils from your presence. No flesh or magic can halt your creeping devastation.", loreEffect: "Your damage-over-time effects bypass all defenses, inflicting absolute decay." }
                        ]
                    },
                    'soulbinder': {
                        name: 'Soulbinder',
                        theme: 'Soul manipulation, linking, possession.',
                        resourceEvolution: [], // Soul Energy does not evolve in type for this branch
                        stages: [
                            { level: 3, name: 'Soulbinder', trait: 'Soul Chain', traitEffect: 'Link 2 targets; dmg to one hits both.', skill: 'Soul Chain', lore: "You grasp the ethereal strands of life and death, binding destinies together. No soul is truly free from your touch.", loreEffect: "You can now link enemies, causing them to share damage." },
                            { level: 5, name: 'Chain of Woe', trait: 'Link up to 3 enemies.', traitEffect: 'Extend your spiritual dominion, binding more foes in shared suffering.', skill: 'Soul Chain', lore: "Your network of suffering expands, ensnaring more souls in a dance of shared torment. Their agony fuels your power.", loreEffect: "You can link up to three enemies simultaneously." },
                            { level: 8, name: 'Wraithlord', trait: 'Possession', traitEffect: 'Control an enemy for 1 turn.', skill: 'Possession', lore: "Your consciousness slips into the minds of your enemies, turning their strength against their own kind. You are the unseen puppeteer.", loreEffect: "You gain the terrifying ability to temporarily seize control of an enemy." },
                            { level: 11, name: 'Eidolon King', trait: 'Drains 2 HP/turn from all linked enemies.', traitEffect: 'Your linked victims continuously suffer, their life force flowing into you.', skill: 'Echo of Nothing', lore: "Your very presence siphons vitality from those you bind. The more suffering, the stronger your dominion.", loreEffect: "Linked enemies suffer passive health drain, fueling your continued existence." },
                            { level: 14, name: 'Eternal Lich', trait: 'First death per fight resurrects you at 50% HP.', traitEffect: 'Defy death itself, rising again to continue your macabre work.', skill: 'Unmake', ascended: true, lore: "Mortality is but a fleeting illusion. You have transcended the cycle, a timeless being of arcane and necromantic might.", loreEffect: "You are granted a single resurrection per fight, ensuring your enduring presence on the battlefield.", secretEvolutionTrigger: true } // Flag for Hollow King
                        ]
                    }
                }
            }
            // Future: 'mage' and 'rogue' evolution paths will go here
        };

        // --- Legendary and Secret Class Data (Not part of direct evolution tree) ---
        const legendaryAndSecretClasses = {
            'deathlord_eternal': {
                name: 'Deathlord Eternal',
                description: 'The ultimate master of undeath, capable of limitless legions and absolute dominion over the fallen.',
                unlockPath: 'Eternal Lich (Necromancer) + Abyssal King (Warrior) + Throne of Bones event.',
                mechanic: 'Legion of the Dead â€” Unlimited minion cap for 5 turns.',
                signatureSkill: 'Deathâ€™s Dominion',
                lore: 'You have claimed dominion over both the abyss and the grave, weaving a tapestry of endless servitude. Life and death bend to your every whim, and entire armies are but puppets on your strings.'
            },
            'the_hollow_king': {
                name: 'The Hollow King',
                description: 'A crown of absence. A throne of silence. The world itself forgets your name.',
                unlockConditions: 'Start Necromancer (Soulbinder path). Reach Eternal Lich. During Throne of Bones, die while controlling at least 3 enemy souls. Revive not as yourself, but as The Hollow King.',
                coreResource: { type: 'Hollow Will', initial: 0, max: 5, gain: 'from erasing enemies (permanent removal from battle)' },
                passives: [
                    { name: 'Life Inversion', effect: 'Damage heals you; healing damages you.' },
                    { name: 'Soul Erasure', effect: 'Kills leave no corpse; enemies cannot be revived.' },
                    { name: 'Unshackled Command', effect: 'Unlimited summons, but each drains 2% max HP/turn.' },
                    { name: 'Crown of the Undying', effect: 'If you die, resurrect next turn with 30% HP. Consumes all Hollow Will and permanently reduces max HP by 10%. Cannot trigger if max HP is below 25% of original.' }
                ],
                skills: ['Unmake', 'Hollow Crown', 'Echo of Nothing'], // Hollow Crown is a passive skill effect
                overdrive: { name: 'Oblivionâ€™s Call', description: 'Entire enemy side erased for 1 turn; they cannot act or be targeted.' },
                playstyleSummary: [
                    'Absolute control â€” can delete enemies, skip turns, swarm with infinite summons.',
                    'Immortalâ€¦ for a price â€” every death brings you back weaker, forcing long-term survival planning.',
                    'Self-sabotaging power â€” summons drain your life, but youâ€™re healed by damage, encouraging a hyper-aggressive style.'
                ]
            }
        };

        // --- Global Game State Variables ---
        let currentRoom = 'starting_room';
        let gameActive = true;
        let awaitingClassSelection = false;
        let awaitingBranchSelection = false;

        let playerStats = {
            currentHP: 0,
            maxHP: 0,
            strength: 0,
            intelligence: 0,
            agility: 0,
            baseDamageMin: 0,
            baseDamageMax: 0,
            level: 1,
            experience: 0,
            expToNextLevel: 100,
            resource: { type: 'None', current: 0, max: 0 },
            inventory: [],
            activeSkills: [],
            activeTraits: [],
            // Special flags for Legendary/Secret forms
            isHollowKing: false,
            // Add other game-wide flags/counters here as needed (e.g., number of enemies controlled for Hollow King unlock)
            controlledSouls: 0 // Placeholder for Hollow King unlock condition
        };

        let playerProgression = {
            baseClass: null,
            currentBranch: null,
            currentEvolutionName: null,
            currentEvolutionStageIndex: 0
        };

        // --- Game Functions ---

        /**
         * Adds a message to the game output display.
         * @param {string} message - The text message to display.
         * @param {boolean} isImportant - If true, displays the message in bold.
         */
        function displayMessage(message, isImportant = false) {
            const p = document.createElement('p');
            if (isImportant) {
                p.innerHTML = `<strong>${message}</strong>`;
            } else {
                p.textContent = message;
            }
            gameOutput.appendChild(p);
            gameOutput.scrollTop = gameOutput.scrollHeight;
        }

        /**
         * Initializes player stats and progression based on the chosen base class.
         * @param {string} className - The key for the chosen base class (e.g., 'warrior').
         */
        function initializePlayer(className) {
            const baseClassInfo = basePlayerClasses[className];
            if (baseClassInfo) {
                playerStats.currentHP = baseClassInfo.baseStats.hp;
                playerStats.maxHP = baseClassInfo.baseStats.hp;
                playerStats.strength = baseClassInfo.baseStats.strength;
                playerStats.intelligence = baseClassInfo.baseStats.intelligence;
                playerStats.agility = baseClassInfo.baseStats.agility;
                playerStats.baseDamageMin = baseClassInfo.baseStats.baseDamageMin;
                playerStats.baseDamageMax = baseClassInfo.baseStats.baseDamageMax;
                playerStats.level = 1;
                playerStats.experience = 0;
                playerStats.expToNextLevel = 100;
                playerStats.inventory = [...baseClassInfo.startingItems];
                playerStats.activeSkills = [...baseClassInfo.startingSkills];
                playerStats.activeTraits = [...baseClassInfo.startingTraits];
                playerStats.resource = {
                    type: baseClassInfo.startingResource.type,
                    current: baseClassInfo.startingResource.initial,
                    max: baseClassInfo.startingResource.max
                };
                playerStats.isHollowKing = false; // Reset for new game

                playerProgression.baseClass = className;
                playerProgression.currentBranch = null;
                playerProgression.currentEvolutionName = baseClassInfo.name || className.charAt(0).toUpperCase() + className.slice(1);
                playerProgression.currentEvolutionStageIndex = 0;
            } else {
                console.error("Attempted to initialize with an invalid class:", className);
            }
        }


        /**
         * Starts or restarts the game.
         */
        function startGame() {
            gameOutput.innerHTML = ''; // Clear previous game output
            displayMessage("Welcome to the Retro Adventure!", true);
            displayMessage("To begin your journey, choose your path. Available classes:");

            // List available classes
            for (const className in basePlayerClasses) {
                displayMessage(`- ${className.charAt(0).toUpperCase() + className.slice(1)}: ${basePlayerClasses[className].description}`);
            }
            displayMessage("Type the name of the class you wish to play (e.g., 'warrior', 'mage', 'rogue', 'necromancer').", true);

            // Reset game state for a new game
            currentRoom = 'starting_room';
            gameActive = true;
            awaitingClassSelection = true;
            awaitingBranchSelection = false;
            gameInput.focus();
        }

        /**
         * Displays the description of the current room and available actions.
         */
        function displayRoomDescription() {
            const room = rooms[currentRoom];
            if (room) {
                displayMessage("--- " + currentRoom.replace(/_/g, ' ').toUpperCase() + " ---", true);
                displayMessage(room.description);

                displayMessage("\nWhat do you do?");

                // Display Exits
                if (Object.keys(room.exits).length > 0) {
                    displayMessage("\n-- Exits --", true);
                    for (const direction in room.exits) {
                        displayMessage(`ðŸ‘£ Go ${direction}`);
                    }
                }

                // Display Items
                if (room.items && room.items.length > 0) {
                    displayMessage("\n-- Items here --", true);
                    room.items.forEach(item => {
                        displayMessage(`âœ‹ Take ${item}`);
                    });
                }

                // Display Available Skills
                if (playerStats.activeSkills.length > 0 && playerProgression.baseClass) {
                    displayMessage("\n-- Skills --", true);
                    playerStats.activeSkills.forEach(skillName => {
                        const skillInfo = skillDefinitions[skillName];
                        if (skillInfo) {
                            let skillDisplay = `âœ¨ Use ${skillName} (${skillInfo.description})`;
                            if (skillInfo.cost > 0 || skillInfo.cost === 'all') {
                                skillDisplay += ` [Cost: ${skillInfo.cost} ${playerStats.resource.type}]`;
                            }
                            displayMessage(skillDisplay);
                        } else {
                            displayMessage(`âœ¨ Use ${skillName} (Description missing!)`);
                        }
                    });
                }

                // Generic commands always available
                displayMessage("\n-- General Commands --", true);
                displayMessage("ðŸ“œ Inventory (i)");
                displayMessage("ðŸ‘€ Look (re-examine room)");
                displayMessage("ðŸ“Š Stats (view character sheet)");
                displayMessage("â“ Help (list all commands)");
                displayMessage("ðŸšª Quit (end game)");


            } else {
                displayMessage("Error: You are in an unknown place. This shouldn't happen!", true);
            }
        }

        /**
         * Adds experience points to the player and checks for level up.
         * For now, this is a manual command, but eventually it will be from combat/quests.
         * @param {number} amount - The amount of experience to add.
         */
        function addExperience(amount) {
            playerStats.experience += amount;
            displayMessage(`You gained ${amount} experience points!`);
            checkLevelUp();
        }

        /**
         * Checks if the player has enough experience to level up and handles it.
         */
        function checkLevelUp() {
            while (playerStats.experience >= playerStats.expToNextLevel) {
                playerStats.experience -= playerStats.expToNextLevel;
                playerStats.level++;
                playerStats.expToNextLevel = Math.floor(playerStats.expToNextLevel * 1.5);

                displayMessage(`Congratulations! You have reached Level ${playerStats.level}!`, true);
                // Apply stat bonuses (simple example: +1 str, int, agi per level)
                playerStats.strength += 1;
                playerStats.intelligence += 1;
                playerStats.agility += 1;
                playerStats.maxHP += 10;
                playerStats.currentHP = playerStats.maxHP;

                handleEvolution();
            }
        }

        /**
         * Handles class evolution based on level and current branch.
         * This function will also prompt for branch selection at Level 3.
         */
        function handleEvolution() {
            // If player is The Hollow King, standard evolution stops
            if (playerStats.isHollowKing) {
                displayMessage("Your form is beyond conventional evolution. The Hollow King simply... is.", true);
                return;
            }

            const currentBaseClass = evolutionPaths[playerProgression.baseClass];

            if (!currentBaseClass) {
                console.warn("No evolution path found for base class:", playerProgression.baseClass);
                return;
            }

            // Handle Branch Selection at Level 3
            if (playerStats.level === 3 && !playerProgression.currentBranch) {
                displayMessage("You feel a surge of new power! It's time to specialize.", true);
                displayMessage("Choose your path: ");
                const branches = Object.keys(currentBaseClass.branches);
                branches.forEach(branch => {
                    displayMessage(`- ${branch.charAt(0).toUpperCase() + branch.slice(1)}: ${currentBaseClass.branches[branch].theme}`);
                });
                displayMessage("Type the name of the branch you wish to pursue (e.g., 'vanguard', 'berserker', 'warden' for Warrior; 'bone_warden', 'plaguecaller', 'soulbinder' for Necromancer).", true);
                awaitingBranchSelection = true;
                return;
            }

            // Handle subsequent stage evolutions
            if (playerProgression.currentBranch) {
                const currentBranchPath = currentBaseClass.branches[playerProgression.currentBranch].stages;
                const nextStageIndex = playerProgression.currentEvolutionStageIndex + 1;

                if (nextStageIndex < currentBranchPath.length) {
                    const nextStage = currentBranchPath[nextStageIndex];

                    // Check if level requirement is met
                    if (playerStats.level >= nextStage.level) {
                        // Check for special unlock triggers (not implemented yet, but ready for it)
                        if (nextStage.unlockTrigger) {
                            displayMessage(`You sense a powerful shift, but you need to achieve the '${nextStage.unlockTrigger}' to fully unlock your next evolution.`);
                            return;
                        }

                        // Evolve!
                        playerProgression.currentEvolutionStageIndex = nextStageIndex;
                        playerProgression.currentEvolutionName = nextStage.name;

                        // Display lore blurb first
                        displayMessage(`\n--- Your destiny unfolds! You become a ${nextStage.name}! ---`, true);
                        if (nextStage.lore) {
                            displayMessage(`"${nextStage.lore}"`);
                        }
                        if (nextStage.loreStance) {
                            displayMessage(`Stance: ${nextStage.loreStance}`);
                        }
                        if (nextStage.loreEffect) {
                            displayMessage(nextStage.loreEffect);
                        }
                        displayMessage("---------------------------------------------", true);

                        // Apply new skill and trait (displayed after lore)
                        if (nextStage.skill) {
                            // Only add skill if not already present (prevents duplicates from temporary re-initialization etc.)
                            if (!playerStats.activeSkills.includes(nextStage.skill)) {
                                playerStats.activeSkills.push(nextStage.skill);
                            }
                            displayMessage(`You learned a new skill: ${nextStage.skill}! (${skillDefinitions[nextStage.skill]?.description || 'No description available'})`, true);
                        }
                        if (nextStage.trait) {
                            playerStats.activeTraits.push({ name: nextStage.trait, effect: nextStage.traitEffect });
                            displayMessage(`You gained a new trait: ${nextStage.trait}! (${nextStage.traitEffect})`, true);
                        }

                        // Update resource type if it changes based on resourceEvolution array
                        const resourceChange = currentBaseClass.branches[playerProgression.currentBranch].resourceEvolution?.find(res => res.level === nextStage.level && res.stage === nextStage.name);
                        if (resourceChange) {
                            playerStats.resource.type = resourceChange.type;
                            displayMessage(`Your resource has transformed into: ${playerStats.resource.type}!`);
                        }

                        // Check for secret evolution trigger (e.g., Eternal Lich for Hollow King)
                        if (nextStage.secretEvolutionTrigger && playerStats.controlledSouls >= 3 /* and other conditions like Throne of Bones event active */) {
                            // This would be the actual trigger point for a "cinematic moment"
                            // For now, just a placeholder message
                            displayMessage("A dark ritual is complete! You feel an unholy transformation... the world shifts around you.", true);
                            // Set Hollow King state (this needs more sophisticated game state management for real game)
                            playerStats.isHollowKing = true;
                            playerProgression.currentEvolutionName = legendaryAndSecretClasses.the_hollow_king.name;
                            // Apply Hollow King specific stats, skills, traits
                            playerStats.activeSkills = [...legendaryAndSecretClasses.the_hollow_king.skills];
                            playerStats.activeTraits = [...legendaryAndSecretClasses.the_hollow_king.passives];
                            playerStats.resource = { ...legendaryAndSecretClasses.the_hollow_king.coreResource };
                            // Also need to adjust HP based on Hollow King's Life Inversion etc.
                            displayMessage(`You have transcended mortality and become ${legendaryAndSecretClasses.the_hollow_king.name}!`, true);
                            displayMessage(legendaryAndSecretClasses.the_hollow_king.description, true);
                            displayMessage(legendaryAndSecretClasses.the_hollow_king.playstyleSummary.join('\n'), true);
                        }

                    }
                }
            }
        }

        /**
         * Generates formatted strings for the class evolution tree and lore views.
         * This includes textual indicators for Ascended and Event/Boss unlocks.
         * @returns {object} An object containing 'tree' and 'lore' formatted strings.
         */
        function getClassEvolutionFormattedViews() {
            // If player is Hollow King, display only its unique info
            if (playerStats.isHollowKing) {
                const hk = legendaryAndSecretClasses.the_hollow_king;
                let treeView = `\n--- Your Ascended Form: ${hk.name} ---\n`;
                treeView += `  Beyond the conventional tree. You are absence.\n`;
                let loreView = `\n--- The Hollow King Lore ---\n`;
                loreView += `<strong>${hk.name}</strong>:\n`;
                loreView += `  "${hk.description}"\n`;
                loreView += `\nCore Resource: ${hk.coreResource.type} (gain ${hk.coreResource.gain}, max ${hk.coreResource.max})\n`;
                loreView += `\nPassives:\n`;
                hk.passives.forEach(p => loreView += `  - ${p.name}: ${p.effect}\n`);
                loreView += `\nSkills:\n`;
                hk.skills.forEach(s => loreView += `  - ${s}: ${skillDefinitions[s]?.description || 'Description missing!'}\n`);
                loreView += `\nOverdrive: ${hk.overdrive.name} - ${hk.overdrive.description}\n`;
                loreView += `\nPlaystyle:\n`;
                hk.playstyleSummary.forEach(s => loreView += `  - ${s}\n`);
                return { tree: treeView, lore: loreView };
            }


            const baseClass = playerProgression.baseClass;
            if (!baseClass) {
                return { tree: "No class selected yet.", lore: "" };
            }

            const evolutionData = evolutionPaths[baseClass];
            let treeView = `\n--- Evolution Tree for ${baseClass.charAt(0).toUpperCase() + baseClass.slice(1)} ---\n`;
            let loreView = `\n--- Class Lore for ${baseClass.charAt(0).toUpperCase() + baseClass.slice(1)} ---\n`;

            // Base Class Entry for Lore View
            loreView += `\n<strong>${baseClass.charAt(0).toUpperCase() + baseClass.slice(1)} (Lv1)</strong>:\n`;
            if (basePlayerClasses[baseClass].lore) {
                loreView += `  "${basePlayerClasses[baseClass].lore.base}"\n`;
                loreView += `  Role: ${basePlayerClasses[baseClass].lore.role}\n`;
                loreView += `  Identity: ${basePlayerClasses[baseClass].lore.identity}\n`;
            } else {
                loreView += `  Description: ${basePlayerClasses[baseClass].description}\n`;
            }
            loreView += `  Core Resource: ${basePlayerClasses[baseClass].startingResource.type} (`;
            if (baseClass === 'warrior') loreView += 'gain +1 per hit, lose all if you skip a turn';
            else if (baseClass === 'necromancer') loreView += 'gained from kills (+1, +2 if you land the killing blow)';
            else loreView += '...details';
            loreView += `), max ${basePlayerClasses[baseClass].startingResource.max}\n`;
            loreView += `  Starting Skills: ${basePlayerClasses[baseClass].startingSkills.map(s => skillDefinitions[s]?.description ? `${s} (${skillDefinitions[s].description})` : s).join(', ')}\n`;
            loreView += `  Passive: ${basePlayerClasses[baseClass].startingTraits.map(t => `${t.name} â€” ${t.effect}`).join(', ')}\n`;


            // Sort branches alphabetically for consistent display
            const sortedBranchKeys = Object.keys(evolutionData.branches).sort();

            sortedBranchKeys.forEach(branchKey => {
                const branch = evolutionData.branches[branchKey];
                treeView += `\nBranch: ${branch.name} (${branch.theme})\n`;
                loreView += `\n--- Branch: ${branch.name} ---\n`;
                loreView += `  Theme: ${branch.theme}\n`;
                if (branch.resourceEvolution && branch.resourceEvolution.length > 0) {
                    loreView += `  Branch Resource: ${branch.resourceEvolution[0].type} â€” `; // First resource type in the evolution
                    if (branch.name === 'Vanguard') {
                        loreView += 'gain by guarding or intercepting hits for allies.\n';
                        loreView += '  Dark Knight replaces these with Sin Marks (double dmg but self-harm).\n';
                    } else if (branch.name === 'Berserker') {
                        loreView += '+1 when hitting or taking dmg, max 10. At max Fury, next skill is doubled in dmg.\n';
                    } else if (branch.name === 'Warden') {
                        loreView += 'apply [Pin], [Expose], or [Weaken] marks to enemies. Max 3 marks per enemy.\n';
                    } else if (branch.name === 'Plaguecaller') {
                        loreView += 'Infection Stacks â€” DoTs can stack up to 3x on same enemy.\n';
                    } else if (branch.name === 'Soulbinder') {
                        loreView += 'Soul Chains â€” Linked enemies share damage.\n';
                    } else {
                        loreView += '...details.\n'; // Fallback
                    }
                }


                branch.stages.forEach((stage, index) => {
                    const isCurrent = playerProgression.currentBranch === branchKey && playerProgression.currentEvolutionStageIndex === index;
                    let statusIndicator = isCurrent ? ' (CURRENT)' : '';

                    let nameDisplayForTree = stage.name;
                    let loreStageTitle = `Level ${stage.level} - ${stage.name}`;

                    // Apply textual "color coding"
                    if (stage.ascended) {
                        nameDisplayForTree = `<strong><span style="color: #f6ad55;">${stage.name} (Ascended)</span></strong>`; // Gold for Ascended
                        loreStageTitle = `<strong><span style="color: #f6ad55;">Level ${stage.level} - ${stage.name} (Ascended Form)</span></strong>`;
                    } else if (stage.unlockTrigger) {
                        nameDisplayForTree = `<strong><span style="color: #fc8181;">${stage.name} (Event/Boss Unlock)</span></strong>`; // Red for Event/Boss
                        loreStageTitle = `<strong><span style="color: #fc8181;">Level ${stage.level} - ${stage.name} (Requires: ${stage.unlockTrigger})</span></strong>`;
                    } else {
                        nameDisplayForTree = `<strong><span style="color: #90cdf4;">${stage.name}</span></strong>`; // Blue for Normal evolution
                        loreStageTitle = `<strong><span style="color: #90cdf4;">Level ${stage.level} - ${stage.name}</span></strong>`;
                    }


                    treeView += `  L${stage.level}: ${nameDisplayForTree}${statusIndicator}\n`;

                    loreView += `\n${loreStageTitle}:\n`;
                    if (stage.lore) {
                        loreView += `  "${stage.lore}"\n`;
                    }
                    if (stage.loreStance) {
                        loreView += `  Stance: ${stage.loreStance}\n`;
                    }
                    if (stage.loreEffect) {
                        loreView += `  ${stage.loreEffect}\n`;
                    }

                    loreView += `  Passive: ${stage.trait} â€” ${stage.traitEffect}\n`;
                    if (stage.skill) {
                        const skillInfo = skillDefinitions[stage.skill];
                        loreView += `  Skill: ${stage.skill} â€” ${skillInfo?.description || 'Description missing.'}\n`;
                    }
                    if (stage.combatFlavor) {
                        loreView += `  Combat Log Flavor: "${stage.combatFlavor}"\n`;
                    }
                    if (stage.prestigeQuest) {
                        loreView += `  Prestige Quest: "${stage.prestigeQuest}" â€” win duel â†’ gain Mounted Charge skill.\n`;
                    }
                    if (stage.secretEvolutionTrigger && baseClass === 'necromancer' && branchKey === 'soulbinder' && stage.name === 'Eternal Lich') {
                        loreView += `\n  This form is a prerequisite for the ultimate hidden class: <strong>The Hollow King</strong>.\n`;
                        loreView += `  Unlock Conditions: Start Necromancer (Soulbinder path). Reach Eternal Lich. During Throne of Bones, die while controlling at least 3 enemy souls. Revive not as yourself, but as The Hollow King.\n`;
                    }
                });
            });

            // Add hint about Legendary Unlock for Warrior (if base class is warrior)
            if (baseClass === 'warrior') {
                loreView += "\n\n" + "Some paths go darker still... a Legendary truth awaits discovery." + "\n";
            }
            // Add hint about Deathlord Eternal for Necromancer (if base class is necromancer and current branch is Soulbinder)
            if (baseClass === 'necromancer') {
                loreView += `\n\n${legendaryAndSecretClasses.deathlord_eternal.name} (${legendaryAndSecretClasses.deathlord_eternal.unlockPath})\n`;
            }


            // Append Ascended Overdrives at the very end of the lore view for easy reference
            if (playerProgression.currentEvolutionName && playerProgression.currentEvolutionStageIndex !== -1 &&
                evolutionPaths[baseClass].branches[playerProgression.currentBranch]?.stages[playerProgression.currentEvolutionStageIndex]?.ascended) {
                const currentAscendedSkillName = evolutionPaths[baseClass].branches[playerProgression.currentBranch].stages[playerProgression.currentEvolutionStageIndex].skill;
                const skillInfo = skillDefinitions[currentAscendedSkillName];

                if (currentAscendedSkillName && skillInfo) {
                    loreView += "\n--- Ascended Overdrive (Current Class) ---\n";
                    loreView += `\n<strong>${currentAscendedSkillName}</strong>: ${skillInfo.description} (1/fight)\n`;
                } else {
                    loreView += "\n--- Ascended Overdrive (Current Class) ---\n";
                    loreView += "No specific Ascended Overdrive found for current class.\n"; // Fallback for ascended with no skill
                }
            }


            return { tree: treeView, lore: loreView };
        }


        /**
         * Processes the player's command.
         * @param {string} commandText - The command entered by the player.
         */
        function processCommand(commandText) {
            const cleanedCommand = commandText.toLowerCase().trim();
            gameInput.value = '';

            if (!gameActive && cleanedCommand !== 'start') {
                displayMessage("The game is over. Type 'start' to play again.", true);
                return;
            }

            // --- Handle Class Selection Phase ---
            if (awaitingClassSelection) {
                if (basePlayerClasses[cleanedCommand]) {
                    initializePlayer(cleanedCommand);
                    awaitingClassSelection = false;
                    displayMessage(`You have chosen to be a ${playerProgression.baseClass.charAt(0).toUpperCase() + playerProgression.baseClass.slice(1)}!`, true);
                    displayMessage(`Your journey begins with: ${playerStats.inventory.join(', ')}.`);
                    displayRoomDescription();
                } else {
                    displayMessage("That is not a valid class. Please choose from: " + Object.keys(basePlayerClasses).join(', ') + ".");
                }
                return;
            }

            // --- Handle Branch Selection Phase (Level 3) ---
            if (awaitingBranchSelection) {
                const availableBranches = Object.keys(evolutionPaths[playerProgression.baseClass].branches);
                if (availableBranches.includes(cleanedCommand)) {
                    playerProgression.currentBranch = cleanedCommand;
                    // Find the index of the stage at the current level (3)
                    playerProgression.currentEvolutionStageIndex = evolutionPaths[playerProgression.baseClass].branches[playerProgression.currentBranch].stages.findIndex(s => s.level === playerStats.level);
                    awaitingBranchSelection = false;
                    displayMessage(`You have chosen the path of the ${cleanedCommand.charAt(0).toUpperCase() + cleanedCommand.slice(1)}!`, true);
                    handleEvolution(); // Trigger evolution for Level 3 branch
                } else {
                    displayMessage("That is not a valid branch. Please choose from: " + availableBranches.join(', ') + ".");
                }
                return;
            }


            // --- Normal Game Command Processing ---
            displayMessage(`> ${commandText}`, true);

            const commandParts = cleanedCommand.split(' ');
            const mainCommand = commandParts[0];
            const argument = commandParts.slice(1).join(' ');

            switch (mainCommand) {
                case 'go':
                    if (argument) {
                        movePlayer(argument);
                    } else {
                        displayMessage("Go where? Try 'go north' or 'go east'.");
                    }
                    break;
                case 'take':
                case 'get':
                    if (argument) {
                        takeItem(argument);
                    } else {
                        displayMessage("Take what? Try 'take key' or 'get mushroom'.");
                    }
                    break;
                case 'inventory':
                case 'i':
                    showInventory();
                    break;
                case 'look':
                    displayRoomDescription();
                    break;
                case 'help':
                    displayMessage("Available commands: go [direction], take [item], inventory (i), look, help, quit, stats, add_xp [amount], use [skill].");
                    break;
                case 'quit':
                    displayMessage("Thanks for playing! Game Over.", true);
                    gameActive = false;
                    break;
                case 'start':
                    startGame();
                    break;
                case 'stats':
                    displayPlayerStats();
                    break;
                case 'add_xp':
                    const xpAmount = parseInt(argument);
                    if (!isNaN(xpAmount) && xpAmount > 0) {
                        addExperience(xpAmount);
                    } else {
                        displayMessage("Usage: add_xp [amount]. Amount must be a positive number.");
                    }
                    break;
                case 'use':
                    if (argument) {
                        useSkill(argument);
                    } else {
                        displayMessage("Use what skill? Type 'use [skill name]'.");
                    }
                    break;
                // Temporary command for Hollow King testing (remove in final game)
                case 'become_hollow_king':
                    if (playerProgression.baseClass === 'necromancer' && playerProgression.currentEvolutionName === 'Eternal Lich') {
                        playerStats.isHollowKing = true;
                        playerProgression.currentEvolutionName = legendaryAndSecretClasses.the_hollow_king.name;
                        playerStats.activeSkills = legendaryAndSecretClasses.the_hollow_king.skills;
                        playerStats.activeTraits = legendaryAndSecretClasses.the_hollow_king.passives;
                        playerStats.resource = { ...legendaryAndSecretClasses.the_hollow_king.coreResource };
                        displayMessage(`A forbidden transformation! You are now ${legendaryAndSecretClasses.the_hollow_king.name}!`, true);
                        displayMessage(`"${legendaryAndSecretClasses.the_hollow_king.description}"`, true);
                        displayPlayerStats();
                    } else {
                        displayMessage("You cannot become The Hollow King yet. You must be an Eternal Lich (Necromancer).");
                    }
                    break;
                default:
                    displayMessage("I don't understand that command. Type 'help' for assistance.");
            }
        }

        /**
         * Attempts to move the player to a new room.
         * @param {string} direction - The direction to move (e.g., 'north', 'east').
         */
        function movePlayer(direction) {
            const room = rooms[currentRoom];
            if (room && room.exits[direction]) {
                const newRoom = room.exits[direction];

                // Simple check for wooden door, requires 'old key'
                if (newRoom === 'wooden_door_room' && direction === 'north' && currentRoom === 'starting_room') {
                    if (!playerStats.inventory.includes('old key')) {
                        displayMessage("The heavy wooden door is locked. You need a key!");
                        return;
                    } else {
                        displayMessage("You unlock the heavy wooden door with the old key and it creaks open.");
                    }
                }

                currentRoom = newRoom;
                displayRoomDescription();
            } else {
                displayMessage(`You can't go ${direction} from here.`);
            }
        }

        /**
         * Attempts to add an item from the room to the player's inventory.
         * @param {string} item - The item to take.
         */
        function takeItem(item) {
            const room = rooms[currentRoom];
            if (room && room.items && room.items.includes(item)) {
                playerStats.inventory.push(item);
                room.items = room.items.filter(i => i !== item);
                displayMessage(`You picked up the ${item}.`);
            } else {
                displayMessage(`There's no ${item} here.`);
            }
        }

        /**
         * Displays the player's current inventory.
         */
        function showInventory() {
            if (playerStats.inventory.length === 0) {
                displayMessage("Your inventory is empty.");
            } else {
                displayMessage("Your inventory: " + playerStats.inventory.join(', ') + ".");
            }
        }

        /**
         * Attempts to use a specified skill.
         * Currently, this only displays a message.
         * @param {string} skillName - The name of the skill to use.
         */
        function useSkill(skillName) {
            const normalizedSkillName = skillName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            if (playerStats.activeSkills.includes(normalizedSkillName)) {
                displayMessage(`You attempt to use ${normalizedSkillName}. (Effect not yet implemented!)`);
                // TODO: Implement actual skill effects here, consuming resources, dealing damage, etc.
            } else {
                displayMessage(`You don't have the skill '${normalizedSkillName}'.`);
                displayMessage("Type 'stats' to see your active skills.");
            }
        }

        /**
         * Displays detailed player statistics, current class, skills, and traits.
         */
        function displayPlayerStats() {
            displayMessage("--- Your Character Stats ---", true);
            displayMessage(`Level: ${playerStats.level}`);
            displayMessage(`Experience: ${playerStats.experience}/${playerStats.expToNextLevel}`);
            displayMessage(`HP: ${playerStats.currentHP}/${playerStats.maxHP}`);
            displayMessage(`Strength: ${playerStats.strength}`);
            displayMessage(`Intelligence: ${playerStats.intelligence}`);
            displayMessage(`Agility: ${playerStats.agility}`);
            displayMessage(`Base Damage: ${playerStats.baseDamageMin}-${playerStats.baseDamageMax}`);
            displayMessage(`Resource: ${playerStats.resource.type}: ${playerStats.resource.current}/${playerStats.resource.max}`);

            displayMessage("--- Class Progression ---", true);
            if (playerStats.isHollowKing) {
                displayMessage(`Current Form: ${playerProgression.currentEvolutionName} (The Hollow King)`);
                // Display Hollow King specific stats/info here if needed beyond getClassEvolutionFormattedViews
            } else {
                displayMessage(`Base Class: ${playerProgression.baseClass.charAt(0).toUpperCase() + playerProgression.baseClass.slice(1)}`);
                displayMessage(`Current Evolution: ${playerProgression.currentEvolutionName}`);
                if (playerProgression.currentBranch) {
                    displayMessage(`Chosen Branch: ${playerProgression.currentBranch.charAt(0).toUpperCase() + playerProgression.currentBranch.slice(1)}`);
                } else {
                    displayMessage(`Branch: Not yet specialized (choose at Level 3)`);
                }
            }


            displayMessage("--- Skills ---", true);
            if (playerStats.activeSkills.length > 0) {
                playerStats.activeSkills.forEach(skill => {
                    const skillInfo = skillDefinitions[skill];
                    let skillDisplay = `- ${skill}`;
                    if (skillInfo?.description) {
                        skillDisplay += `: ${skillInfo.description}`;
                    }
                    if (skillInfo?.cost > 0 || skillInfo?.cost === 'all') {
                        skillDisplay += ` [Cost: ${skillInfo.cost} ${skillInfo.resource || 'resource'}]`;
                    }
                    displayMessage(skillDisplay);
                });
            } else {
                displayMessage("No active skills.");
            }

            displayMessage("--- Traits ---", true);
            if (playerStats.activeTraits.length > 0) {
                playerStats.activeTraits.forEach(trait => displayMessage(`- ${trait.name}: ${trait.effect}`));
            } else {
                displayMessage("No active traits.");
            }

            // --- Class Evolution Tree & Lore Views ---
            // These views now correctly handle The Hollow King display
            if (playerProgression.baseClass || playerStats.isHollowKing) {
                const evolutionViews = getClassEvolutionFormattedViews();
                displayMessage(evolutionViews.tree, true);
                displayMessage(evolutionViews.lore, true);
            }
        }


        // --- Event Listeners ---
        gameInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                processCommand(gameInput.value);
            }
        });

        submitButton.addEventListener('click', () => {
            processCommand(gameInput.value);
        });

        // --- Initialize the Game ---
        document.addEventListener('DOMContentLoaded', startGame);
    </script>
</body>
</html>
